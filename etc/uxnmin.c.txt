#include <stdio.h>

typedef unsigned char Uint8;
typedef unsigned short Uint16;

static unsigned int console_vector;
static Uint8 ram[0x10000], dev[0x100], ptr[2], stk[2][0x100];

static Uint8
emu_dei(const Uint8 port)
{
	return dev[port];
}

static void
emu_deo(const Uint8 port, const Uint8 value)
{
	dev[port] = value;
	switch(port) {
	case 0x11: console_vector = dev[0x10] << 8 | value; return;
	case 0x18: fputc(value, stdout); return;
	case 0x19: fputc(value, stderr); return;
	}
}

#define REM *p -= 1 + d;
#define DEC s[--(*p)]
#define INC s[(*p)++]
#define FLIP { s = stk[!r], p = &ptr[!r]; }
#define MOVE { pc = d ? a : pc + (signed char)a; }
#define JUMP(x) { c = ram[pc] << 8, c |= ram[pc + 1]; pc += x + 2; }
#define DROP(o,m) { o = DEC; if(m) o |= DEC << 8; }
#define GRAB(o) if(d) o[1] = DEC; o[0] = DEC;
#define PUSH(i,m) { if(m) c = (i), INC = c >> 8, INC = c; else INC = i; }
#define TAKE(i) INC = i[0]; if(d) INC = i[1];
#define DEVO(o,r) emu_deo(o, r[0]); if(d) emu_deo(o + 1, r[1]);
#define DEVI(i,r) r[0] = emu_dei(i); if(d) r[1] = emu_dei(i + 1);
#define POKE(o,r,m) ram[o] = r[0]; if(d) ram[(o + 1) & m] = r[1];
#define PEEK(i,r,m) r[0] = ram[i]; if(d) r[1] = ram[(i + 1) & m];

#define OPC(opc, A, B) {\
case 0x00|opc:case 0x40|opc:{const int d=0;A B} goto step;\
case 0x20|opc:case 0x60|opc:{const int d=1;A B} goto step;\
case 0x80|opc:case 0xc0|opc:{const int d=0;int k=*p; A *p=k;B} goto step;\
case 0xa0|opc:case 0xe0|opc:{const int d=1;int k=*p; A *p=k;B} goto step;}

static unsigned
uxn_eval(Uint16 pc)
{
	Uint16 a, b, c, x[2], y[2], z[2];
step: {
	Uint8 op = ram[pc++], r = (op >> 6) & 1, *s = stk[r], *p = &ptr[r];
	switch(op) {
	/* BRK */ case 0x00:return 1;
	/* JCI */ case 0x20:if(DEC) JUMP(c) else pc += 2; goto step;
	/* JMI */ case 0x40:JUMP(c) goto step;
	/* JSI */ case 0x60:JUMP(0) INC = pc >> 8; INC = pc; pc += c; goto step;
	/* LI2 */ case 0xa0:INC = ram[pc++];
	/* LIT */ case 0x80:INC = ram[pc++]; goto step;
	/* L2r */ case 0xe0:INC = ram[pc++];
	/* LIr */ case 0xc0:INC = ram[pc++]; goto step;
	/* INC */ OPC(0x01,DROP(a,d),PUSH(a + 1,d))
	/* POP */ OPC(0x02,REM,(void)s;)
	/* NIP */ OPC(0x03,GRAB(x) REM,TAKE(x))
	/* SWP */ OPC(0x04,GRAB(x) GRAB(y),TAKE(x) TAKE(y))
	/* ROT */ OPC(0x05,GRAB(x) GRAB(y) GRAB(z),TAKE(y) TAKE(x) TAKE(z))
	/* DUP */ OPC(0x06,GRAB(x),TAKE(x) TAKE(x))
	/* OVR */ OPC(0x07,GRAB(x) GRAB(y),TAKE(y) TAKE(x) TAKE(y))
	/* EQU */ OPC(0x08,DROP(a,d) DROP(b,d),PUSH(b == a,0))
	/* NEQ */ OPC(0x09,DROP(a,d) DROP(b,d),PUSH(b != a,0))
	/* GTH */ OPC(0x0a,DROP(a,d) DROP(b,d),PUSH(b > a,0))
	/* LTH */ OPC(0x0b,DROP(a,d) DROP(b,d),PUSH(b < a,0))
	/* JMP */ OPC(0x0c,DROP(a,d),MOVE)
	/* JCN */ OPC(0x0d,DROP(a,d) DROP(b,0),if(b) MOVE)
	/* JSR */ OPC(0x0e,DROP(a,d),FLIP PUSH(pc,1) MOVE)
	/* STH */ OPC(0x0f,GRAB(x),FLIP PUSH(x[0],0) if(d) PUSH(x[1],0))
	/* LDZ */ OPC(0x10,DROP(a,0),PEEK(a, x, 0xff) TAKE(x))
	/* STZ */ OPC(0x11,DROP(a,0) GRAB(y),POKE(a, y, 0xff))
	/* LDR */ OPC(0x12,DROP(a,0),PEEK(pc + (signed char)a, x, 0xffff) TAKE(x))
	/* STR */ OPC(0x13,DROP(a,0) GRAB(y),POKE(pc + (signed char)a, y, 0xffff))
	/* LDA */ OPC(0x14,DROP(a,1),PEEK(a, x, 0xffff) TAKE(x))
	/* STA */ OPC(0x15,DROP(a,1) GRAB(y),POKE(a, y, 0xffff))
	/* DEI */ OPC(0x16,DROP(a,0),DEVI(a, x) TAKE(x))
	/* DEO */ OPC(0x17,DROP(a,0) GRAB(y),DEVO(a, y))
	/* ADD */ OPC(0x18,DROP(a,d) DROP(b,d),PUSH(b + a,d))
	/* SUB */ OPC(0x19,DROP(a,d) DROP(b,d),PUSH(b - a,d))
	/* MUL */ OPC(0x1a,DROP(a,d) DROP(b,d),PUSH(b * a,d))
	/* DIV */ OPC(0x1b,DROP(a,d) DROP(b,d),PUSH(a ? b / a : 0,d))
	/* AND */ OPC(0x1c,DROP(a,d) DROP(b,d),PUSH(b & a,d))
	/* ORA */ OPC(0x1d,DROP(a,d) DROP(b,d),PUSH(b | a,d))
	/* EOR */ OPC(0x1e,DROP(a,d) DROP(b,d),PUSH(b ^ a,d))
	/* SFT */ OPC(0x1f,DROP(a,0) DROP(b,d),PUSH(b >> (a & 0xf) << (a >> 4),d))
	}} return 0;
}

static void
console_input(int c, unsigned int type)
{
	dev[0x12] = c, dev[0x17] = type;
	if(console_vector)
		uxn_eval(console_vector);
}

int
main(int argc, char **argv)
{
	FILE *f;
	if(argc < 2)
		return fprintf(stdout, "usage: %s file.rom [args..]\n", argv[0]);
	else if(!(f = fopen(argv[1], "rb")))
		return fprintf(stderr, "%s: %s not found.\n", argv[0], argv[1]);
	fread(&ram[0x100], 0xff00, 1, f), fclose(f);
	dev[0x17] = argc > 2;
	if(uxn_eval(0x100) && console_vector) {
		int i = 2;
		for(; i < argc; i++) {
			char c, *p = argv[i];
			while(!dev[0x0f] && (c = *p++))
				console_input(c, 2);
			console_input(0, 3 + (i == argc - 1));
		}
		while(!dev[0x0f]) {
			char c = fgetc(stdin);
			if(feof(stdin)) break;
			console_input(c, 1);
		}
		console_input(0, 4);
	}
	return dev[0x0f] & 0x7f;
}
